<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BPSR | GEAR STAT PLANNER | LEVEL 140 (Optimized)</title>
    <style>
        /* =========================================
           VISUAL THEME: MIDNIGHT GOLD (LEVEL 140)
           ========================================= */
        :root {
            --bg-body: #0f1014;
            --bg-panel: #181a21;
            --bg-input: #0b0c10;
            --accent: #d4af37;        
            --accent-hover: #f1c40f;
            --primary: #3498db;
            --highlight: #e74c3c;
            --text-main: #ecf0f1;
            --text-muted: #7f8c8d;
            --border: 1px solid #2c3e50;
            --radius: 4px;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-body); color: var(--text-main); 
            padding: 20px; display: flex; justify-content: center; 
            min-height: 100vh; margin: 0;
        }

        .main-wrapper { display: flex; flex-wrap: wrap; gap: 25px; width: 100%; max-width: 1700px; }

        /* PANELS */
        .panel { 
            background-color: var(--bg-panel); padding: 30px; 
            border-radius: var(--radius); box-shadow: 0 4px 20px rgba(0,0,0,0.4); 
            border: var(--border); 
        }
        .planner-panel { flex: 4; min-width: 950px; }
        .calc-panel { 
            flex: 1; min-width: 300px; position: sticky; 
            top: 20px; height: fit-content; background: #121319;
        }

        h2 { 
            text-align: center; color: var(--accent); margin: 0 0 25px 0; 
            font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            border-bottom: 2px solid #2c3e50; padding-bottom: 15px;
        }

        /* CONTROLES */
        .controls-row {
            background: #1c1e26; padding: 20px; border-radius: var(--radius); 
            display: flex; flex-direction: column; align-items: center; 
            gap: 25px; /* Aumentado o espaçamento aqui */
            margin-bottom: 20px; border: var(--border);
        }
        
        .build-selector { display: flex; gap: 20px; justify-content: center; width: 100%; }
        .build-selector input[type="radio"] { display: none; }
        .build-label {
            background: var(--bg-input); border: 1px solid #444; 
            padding: 10px 25px; border-radius: var(--radius); 
            cursor: pointer; font-weight: bold; color: var(--text-muted);
            transition: all 0.2s; min-width: 80px; text-align: center;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .build-label:hover { border-color: var(--accent); color: var(--text-main); }
        .build-selector input[type="radio"]:checked + .build-label {
            background-color: var(--accent); color: #000; border-color: var(--accent);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        /* Ajuste de centralização e separação */
        .spec-wrapper { 
            display: flex; align-items: center; justify-content: center; 
            gap: 15px; width: 100%; 
            padding-top: 10px;
            border-top: 1px solid #333; /* Linha sutil para separar */
        }

        /* INPUTS */
        select, input[type="number"] { 
            background: var(--bg-input); border: 1px solid #333; color: #fff; 
            padding: 8px 5px; border-radius: var(--radius); width: 100%; 
            font-size: 0.85em; transition: 0.2s; box-sizing: border-box;
        }
        select:focus, input:focus { border-color: var(--accent); outline: none; }
        select:disabled, input:disabled { opacity: 0.3; cursor: not-allowed; border-color: transparent; }

        .global-controls {
            background: #1c1e26; padding: 15px; border-radius: var(--radius); 
            display: flex; align-items: center; gap: 20px; margin-bottom: 20px;
            border: var(--border); justify-content: flex-start; flex-wrap: wrap;
        }
        .global-group { display: flex; align-items: center; gap: 10px; }

        /* TABELA GEAR */
        .gear-row { 
            display: grid; 
            /* Slot | Raid | P | S | Reforge | SigilName | SigilLvl | Legendary */
            grid-template-columns: 0.8fr 0.3fr 0.7fr 0.7fr 0.7fr 1.3fr 0.4fr 1.2fr; 
            gap: 8px; align-items: center; padding: 8px 5px; 
            border-bottom: 1px solid #23252e;
        }
        .gear-row:hover { background-color: rgba(255,255,255,0.03); }
        .gear-header { 
            color: var(--accent); font-weight: bold; border-bottom: 2px solid #444; 
            font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .slot-name { font-weight: 600; color: #ccc; font-size: 0.9em; }

        .leg-group { display: grid; grid-template-columns: 2fr 1fr; gap: 5px; width: 100%; }
        
        /* RESULTADOS */
        .raw-gear-stats {
            background-color: #0b0c10; border: 1px solid #333; padding: 15px;
            border-radius: var(--radius); margin-bottom: 20px;
        }
        .raw-row { display: flex; justify-content: space-between; font-size: 0.9em; padding: 6px 0; border-bottom: 1px solid #1a1c24; color: #bbb; }
        .raw-val { color: var(--accent); font-weight: bold; }

        .base-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .input-group label { display: block; font-size: 0.75em; color: #666; margin-bottom: 4px; text-transform: uppercase; font-weight: bold;}

        .results-area { margin-top: 20px; border-top: 2px solid #333; padding-top: 15px; }
        .result-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #23252e; }
        .result-val { color: var(--accent); font-weight: bold; font-size: 1.1em; }

        /* OTIMIZADOR & OUTROS */
        .tab-container { display: flex; justify-content: center; margin-bottom: 25px; gap: 10px; }
        .tab-btn {
            background: transparent; border: 1px solid #2c3e50; color: var(--text-muted); 
            padding: 10px 30px; font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: 0.2s; border-radius: var(--radius);
        }
        .tab-btn.active { background-color: var(--accent); color: #000; border-color: var(--accent); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        button.action-btn { 
            width: 100%; padding: 14px; border: none; border-radius: var(--radius); 
            font-weight: bold; font-size: 1rem; cursor: pointer; color: #fff;
            transition: 0.2s; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-gold { background: var(--accent); color: #000 !important; }
        .btn-blue { background: var(--primary); }
        .btn-blue:hover, .btn-gold:hover { filter: brightness(1.1); transform: translateY(-2px); }

        .btn-clear {
            background: var(--highlight); color: #fff; border: none;
            padding: 6px 14px; border-radius: var(--radius); cursor: pointer;
            font-size: 0.75em; font-weight: bold; margin-left: 5px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-clear:hover { background: #c0392b; }

        .opt-input-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .opt-input-group label { color: var(--accent); font-size: 0.8em; font-weight: bold; display: block; margin-bottom: 5px; text-transform: uppercase; }
        .opt-options { display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap; background: #1c1e26; padding: 15px; border-radius: var(--radius); }
        .opt-check-label { color: #ccc; cursor: pointer; font-weight: 600; font-size: 0.9em; display: flex; align-items: center; gap: 8px; }

        .imagine-section { margin-top: 25px; background-color: #1c1e26; padding: 20px; border-radius: var(--radius); border: var(--border); }
        .imagine-row { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 10px; align-items: center; margin-bottom: 10px; }
        .imagine-title { color: var(--accent); font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 5px; }

        .footer-credits { width: 100%; text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px solid #333; color: #555; font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; }
        .footer-sub { color: #444; font-size: 0.7em; margin-top: 5px; font-weight: bold; }
        .dynamic-note { font-size: 0.8em; color: #888; margin-top: 20px; background: #121319; padding: 15px; border-radius: var(--radius); border-left: 3px solid #333; line-height: 1.6; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="panel planner-panel">
        <h2>BPSR | GEAR STAT PLANNER | LEVEL 140</h2>
        
        <div class="tab-container">
            <button class="tab-btn active" onclick="ui.switchTab('planner', this)">Manual Planner</button>
            <button class="tab-btn" onclick="ui.switchTab('optimizer', this)">Auto-Optimizer</button>
        </div>

        <div class="controls-row">
            <div class="build-selector">
                <label><input type="radio" name="buildType" value="Strength" checked onchange="logic.updateAll()"><span class="build-label">Strength</span></label>
                <label><input type="radio" name="buildType" value="Intelligence" onchange="logic.updateAll()"><span class="build-label">Intelligence</span></label>
                <label><input type="radio" name="buildType" value="Agility" onchange="logic.updateAll()"><span class="build-label">Agility</span></label>
            </div>
            <div class="spec-wrapper">
                <label style="color:var(--text-muted); font-weight:bold;">Class Spec:</label>
                <select id="class-spec" onchange="logic.updateAll()" style="width:200px; border-color: var(--accent); color: var(--accent); font-weight: bold;"></select>
            </div>
        </div>

        <div id="tab-planner" class="tab-content active">
            <div class="global-controls">
                <div class="global-group">
                    <span style="color:var(--accent); font-weight:bold;">Set Reforge:</span>
                    <select onchange="logic.applyGlobal('reforge', this.value)" style="width:140px;">
                        <option value="">- Select -</option>
                        <option value="Versatility">Versatility</option>
                        <option value="Mastery">Mastery</option>
                        <option value="Haste">Haste</option>
                        <option value="Crit">Crit</option>
                        <option value="Luck">Luck</option>
                    </select>
                </div>
                
                <div class="global-group">
                    <span style="color:var(--accent); font-weight:bold;">Set Sigil Lvl:</span>
                    <select id="global-sigil-lvl" onchange="logic.applyGlobal('sigil-lvl', this.value)" style="width:80px;">
                        <option value="">-</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                    <button class="btn-clear" onclick="logic.clearAll()">Clear All</button>
                </div>
            </div>

            <div class="gear-row gear-header">
                <div>Slot</div><div style="text-align:center">Raid</div><div>Primary</div><div>Secondary</div><div>Reforge</div><div>Sigil</div><div>Lvl</div><div>Legendary</div>
            </div>
            <div id="gear-container"></div>
        </div>

        <div id="tab-optimizer" class="tab-content">
            <div class="optimizer-intro">Define your target percentages. The system will simulate thousands of combinations using the squished stat curve.</div>
            <div class="opt-input-grid">
                <div class="opt-input-group"><label>Target Vers %</label><input type="number" id="opt-vers" placeholder="e.g. 10"></div>
                <div class="opt-input-group"><label>Target Mast %</label><input type="number" id="opt-mast" placeholder="e.g. 50"></div>
                <div class="opt-input-group"><label>Target Haste %</label><input type="number" id="opt-haste" placeholder="e.g. 20"></div>
                <div class="opt-input-group"><label>Target Crit %</label><input type="number" id="opt-crit" placeholder="e.g. 20"></div>
                <div class="opt-input-group"><label>Target Luck %</label><input type="number" id="opt-luck" placeholder="e.g. 5"></div>
                <div class="opt-input-group"><label style="color:var(--highlight)">Total Agility</label><input type="number" id="opt-agi" placeholder="Stat Value"></div>
            </div>
            <button class="action-btn btn-gold" onclick="optimizer.run()">Run Smart Optimization</button>
            <div id="opt-status" style="text-align:center; margin-top:10px; color:var(--accent); font-weight:bold; min-height:20px;"></div>
            <div class="opt-options">
                <label class="opt-check-label"><input type="checkbox" id="opt-keep-selected"> Lock Current Gear</label>
                <label class="opt-check-label"><input type="checkbox" id="opt-optimize-imagine"> Optimize Imagines</label>
                <label class="opt-check-label"><input type="checkbox" id="opt-unlimited-raid"> Unlimited Raid Armor</label>
            </div>
        </div>

        <div class="imagine-section">
            <div class="imagine-title">Imagine Slots</div>
            <div class="imagine-row">
                <span class="slot-name">Imagine 1</span>
                <select id="img-type-1" onchange="logic.calculate()"></select>
                <select id="img-lvl-1" onchange="logic.calculate()"></select>
            </div>
            <div class="imagine-row">
                <span class="slot-name">Imagine 2</span>
                <select id="img-type-2" onchange="logic.calculate()"></select>
                <select id="img-lvl-2" onchange="logic.calculate()"></select>
            </div>
        </div>

        <div class="dynamic-note" id="dynamic-footer-note"></div>
        <div class="footer-credits">
            <div id="credits-area"></div>
            <div class="footer-sub">Supported by: Boss the Block Father</div>
        </div>
    </div>

    <div class="panel calc-panel">
        <h2 style="font-size: 1.2rem; border-bottom: none; margin-bottom: 10px;">STATS OVERVIEW</h2>
        <div class="raw-gear-stats">
            <h3 style="margin:0 0 10px 0; font-size:0.9em; color:#666; border-bottom:1px solid #333; padding-bottom:5px; text-transform:uppercase;">Raw Totals</h3>
            <div class="raw-row"><span>Vers:</span> <span class="raw-val" id="raw-vers">0</span></div>
            <div class="raw-row"><span>Mast:</span> <span class="raw-val" id="raw-mast">0</span></div>
            <div class="raw-row"><span>Haste:</span> <span class="raw-val" id="raw-haste">0</span></div>
            <div class="raw-row"><span>Crit:</span> <span class="raw-val" id="raw-crit">0</span></div>
            <div class="raw-row"><span>Luck:</span> <span class="raw-val" id="raw-luck">0</span></div>
        </div>
        
        <div class="base-stats">
            <div class="input-group"><label>Base Vers</label><input type="number" id="base-vers" value="0"></div>
            <div class="input-group"><label>Base Mast</label><input type="number" id="base-mast" value="0"></div>
            <div class="input-group"><label>Base Haste</label><input type="number" id="base-haste" value="0"></div>
            <div class="input-group"><label>Base Crit</label><input type="number" id="base-crit" value="0"></div>
            <div class="input-group"><label>Base Luck</label><input type="number" id="base-luck" value="0"></div>
            <div class="input-group"><label style="color:#aaa">Base Agi</label><input type="number" id="base-agi" value="0"></div>
        </div>

        <button class="action-btn btn-blue" onclick="logic.calculate()">Update Stats</button>

        <div class="results-area">
            <h3 style="color:var(--text-main); margin-top:0;">Final Breakdown</h3>
            <div class="result-row"><span>Versatility:</span> <span class="result-val" id="r-vers">0%</span></div>
            <div class="result-row"><span>Mastery:</span> <span class="result-val" id="r-mast">6.00%</span></div>
            <div class="result-row"><span>Haste:</span> <span class="result-val" id="r-haste">0%</span></div>
            <div class="result-row"><span>Crit Rate:</span> <span class="result-val" id="r-crit">5.00%</span></div>
            <div class="result-row"><span>Luck:</span> <span class="result-val" id="r-luck">5.00%</span></div>
            
            <div id="extra-bonuses" style="margin-top:15px; border-top:1px dashed #444; padding-top:10px;">
            </div>
            
            <div id="legendary-summary" style="display:none; margin-top:15px; font-size:0.9em; border-top:1px solid #333; padding-top:10px;">
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. DATA CONFIGURATION (LEVEL 140 DATA) ---
    const GAME_DATA = {
        TEXT: { CREDITS: "Produced by Luxxio // Updated by: KrowMeLL / RaoH", NOTES: `<strong>Gear Values (Lvl 140):</strong><br>• Raid Weapon: 1966 Primary / 1966 Secondary / No Reforge<br>• Raid Armor: 756 Primary / 756 Secondary / 226 Reforge <br>• Standard Weapon: 1512 Primary / 756 Secondary / 453 Reforge<br>• Standard Armor: 756 Primary / 378 Secondary / 226 Reforge` },
        STATS: ["Versatility", "Mastery", "Haste", "Crit", "Luck"],
        SLOTS: ["Weapon", "Helmet", "Chest", "Gloves", "Boots", "Earrings", "Necklace", "Ring", "Bracelet (L)", "Bracelet (R)", "Charm"],
        RAID_SLOTS: ["Weapon", "Helmet", "Chest", "Gloves", "Boots", "Bracelet (L)", "Bracelet (R)"],
        
        // --- 140 CURVE TIERS (Kept per instruction for Squish calc) ---
        TIERS: {
            "Versatility": [[0,0], [589,5], [1244,10], [1976,15], [2800,20], [3733,25], [4800,30], [6031,35], [7467,40], [9164,45], [11200,50], [13689,55], [16800,60], [20800,65], [26133,70], [33600,75], [44800,80]],
            "Mastery":     [[0,6], [832,10], [1976,15], [3252,20], [4685,25], [6308,30], [8159,35], [10290,40], [12771,45], [15695,50], [19192,55], [23449,60], [28745,65], [35511,70], [44460,75], [56852,80]],
            "Haste":       [[0,0], [1051,5], [2219,10], [3525,15], [4994,20], [6658,25], [8561,30], [10756,35], [13317,40], [16343,45], [19975,50], [24414,55], [29963,60], [37096,65], [46608,70], [59925,75], [79900,80]],
            "Crit":        [[0,5], [1051,10], [2219,15], [3525,20], [4994,25], [6658,30], [8561,35], [10756,40], [13317,45], [16343,50], [19975,55], [24414,60], [29963,65], [37096,70], [46608,75], [59925,80]],
            "Luck":        [[0,5], [854,10], [1803,15], [2864,20], [4058,25], [5410,30], [6956,35], [8739,40], [10820,45], [13279,50], [16230,55], [19837,60], [24345,65], [30141,70], [37870,75], [48690,80]]
        },

        IMAGINE: { 
            SLOT_IDS: ['1', '2'],
            OPTIONS: {
                "Phantom Arachnocrab (Mastery)": { stat: "Mastery", vals: [3584, 4636, 5688, 6740, 7792, 8960] },
                "Celestial Flier (Haste)": { stat: "Haste", vals: [3584, 4636, 5688, 6740, 7792, 8960] },
                "Goblin King (Versatility)": { stat: "Versatility", vals: [3584, 4636, 5688, 6740, 7792, 8960] },
                "Bluespine Lizard (Versatility)": { stat: "Versatility", vals: [2016, 2615, 3214, 3813, 4412, 5040] }
            }
        },

        LEGENDARY: ["-", "Attack Speed", "Cast Speed", "ATK/MATK", "Dmg Bonus", "Shield", "Healing Output", "Res Break", "All Res", "Armor", "Max HP"],
        RAID_BONUS: {
            "Block": { l: "Luck", v: 6.0, t: "p" }, "Earthfort": { l: "Shield (Vers)", v: 0.0, t: "p" },
            "Iado": { l: "Crit DMG", v: 0.0, t: "p" }, "Moonstrike": { l: "Luck", v: 0.0, t: "p" },
            "Icicle": { l: "Crit DMG", v: 0.0, t: "p" }, "Frostbeam": { l: "Ranged DMG", v: 0, t: "f" },
            "Vanguard": { l: "Melee DMG", v: 0, t: "f" }, "Skyward": { l: "Lucky Strike DMG", v: 20.0, t: "p" },
            "Smite": { l: "Ranged DMG", v: 0, t: "f" }, "Lifebind": { l: "Healing Output", v: 0.0, t: "p" },
            "Wildpack": { l: "Ranged DMG", v: 0, t: "f" }, "Falconry": { l: "Crit DMG", v: 0.0, t: "p" },
            "Recovery": { l: "DMG Bonus", v: 0.0, t: "p" }, "Shield": { l: "Melee DMG", v: 0, t: "f" },
            "Concerto": { l: "Crit Healing", v: 0.0, t: "p" }, "Dissonance": { l: "Luck Effect DMG", v: 0, t: "f" }
        },
        SPECS: { "Vanguard": ["Haste", "Mastery"], "Skyward": ["Crit", "Luck"], "Shield": ["Haste", "Mastery"], "Recovery": ["Crit", "Mastery"], "Iado": ["Crit", "Mastery"], "Moonstrike": ["Haste", "Luck"], "Icicle": ["Crit", "Luck"], "Frostbeam": ["Haste", "Mastery"], "Smite": ["Mastery", "Luck"], "Lifebind": ["Haste", "Mastery"], "Earthfort": ["Mastery", "Versatility"], "Block": ["Mastery", "Luck"], "Wildpack": ["Haste", "Mastery"], "Falconry": ["Crit", "Haste"], "Dissonance": ["Haste", "Luck"], "Concerto": ["Haste", "Crit"] },
        RESTRICTIONS: { "Weapon": { "Strength": [], "Intelligence": [], "Agility": [] }, "Helmet": { "Strength": ["Versatility"], "Intelligence": ["Crit"], "Agility": ["Haste"] }, "Chest": { "Strength": ["Luck"], "Intelligence": ["Crit"], "Agility": ["Mastery"] }, "Gloves": { "Strength": ["Haste"], "Intelligence": ["Versatility"], "Agility": ["Crit"] }, "Boots": { "Strength": ["Mastery"], "Intelligence": ["Luck"], "Agility": ["Crit"] }, "Earrings": { "Strength": ["Mastery"], "Intelligence": ["Versatility"], "Agility": ["Haste"] }, "Necklace": { "Strength": ["Haste"], "Intelligence": ["Luck"], "Agility": ["Mastery"] }, "Ring": { "Strength": ["Luck"], "Intelligence": ["Mastery"], "Agility": ["Versatility"] }, "Bracelet (L)": { "Strength": ["Crit"], "Intelligence": ["Haste"], "Agility": ["Versatility"] }, "Bracelet (R)": { "Strength": ["Crit"], "Intelligence": ["Mastery"], "Agility": ["Luck"] }, "Charm": { "Strength": ["Versatility"], "Intelligence": ["Haste"], "Agility": ["Luck"] } },
        
        // --- LEVEL 140 GEAR VALUES ---
        VALUES: { 
            W_RAID: { p: 1966, s: 1966, r: 0 },    A_RAID: { p: 756, s: 756, r: 226 },
            W_STD:  { p: 1512,  s: 756,  r: 453 }, A_STD:  { p: 756,  s: 378, r: 226 }
        }
    };

    // --- SIGIL DATABASE (LEVEL 140 VALUES) ---
    const SIGIL_DB = [
        { n: "Basilisk Sigil", s: ["Weapon"], d: { 1: {"All Element Attack": 40}, 2: {"All Element Attack": 45}, 3: {"All Element Attack": 50} } },
        { n: "Bluespine Lizard", s: ["Weapon"], d: { 1: {"All Element Attack": 20}, 2: {"All Element Attack": 25}, 3: {"All Element Attack": 30} } },
        { n: "Emerald Caprahorn", s: ["Weapon","Earrings","Necklace","Ring"], d: { 1: {Endurance:80, Strength:25}, 2: {Endurance:90, Strength:30}, 3: {Endurance:100, Strength:35} } },
        { n: "Blackstone Commander", s: ["Weapon","Earrings","Necklace","Ring"], d: { 1: {Endurance:80, Intellect:25}, 2: {Endurance:90, Intellect:30}, 3: {Endurance:100, Intellect:35} } },
        { n: "Blackfire Foxen", s: ["Weapon","Earrings","Necklace","Ring"], d: { 1: {Endurance:80, Agility:25}, 2: {Endurance:90, Agility:30}, 3: {Endurance:100, Agility:35} } },
        { n: "Flamehorn", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Versatility:500}, 2: {Versatility:500}, 3: {Versatility:500} } },
        { n: "Blackstone Captain", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Mastery:500}, 2: {Mastery:560}, 3: {Mastery:600} } },
        { n: "Cabbage Kingpin", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Luck:500}, 2: {Luck:560}, 3: {Luck:600} } },
        { n: "Crimson Foxen", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Haste:500}, 2: {Haste:560}, 3: {Haste:600} } },
        { n: "Goblin Chief", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Crit:500}, 2: {Crit:560}, 3: {Crit:600} } },
        { n: "Cabbage Blaster", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Versatility:200}, 2: {Versatility:250}, 3: {Versatility:300} } },
        { n: "Glimmer Caprahorn", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Mastery:200}, 2: {Mastery:250}, 3: {Mastery:300} } },
        { n: "Cabbage Tough Guy", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Luck:200}, 2: {Luck:250}, 3: {Luck:300} } },
        { n: "Wasteland Foxen", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Haste:200}, 2: {Haste:250}, 3: {Haste:300} } },
        { n: "Cabbage Killer", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Crit:200}, 2: {Crit:250}, 3: {Crit:300} } },
        { n: "Foxen", s: ["Earrings","Necklace","Ring"], d: { 1: {Endurance:50, Agility:15}, 2: {Endurance:60, Agility:20}, 3: {Endurance:80, Agility:25} } },
        { n: "Cabbage Hunter", s: ["Earrings","Necklace","Ring"], d: { 1: {Endurance:50, Intellect:15}, 2: {Endurance:60, Intellect:20}, 3: {Endurance:80, Intellect:25} } },
        { n: "Nether Caprahorn", s: ["Earrings","Necklace","Ring"], d: { 1: {Endurance:50, Strength:15}, 2: {Endurance:60, Strength:20}, 3: {Endurance:80, Strength:25} } },
        { n: "Blackstone Vanguard", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Haste:300}, 2: {Haste:360}, 3: {Haste:420} } },
        { n: "Ruthless Cabbage", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Luck:300}, 2: {Luck:360}, 3: {Luck:420} } },
        { n: "Gloomy Cabbage", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Crit:300}, 2: {Crit:360}, 3: {Crit:420} } },
        { n: "Goblin Shaman", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Versatility:300}, 2: {Versatility:360}, 3: {Versatility:420} } },
        { n: "Goblin Trickster", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Mastery:300}, 2: {Mastery:360}, 3: {Mastery:420} } },
        { n: "Frost Lizard", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Strength:12, Crit:140}, 2: {Strength:16, Crit:175}, 3: {Strength:20, Crit:210} } },
        { n: "Magma Lizard", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Strength:12, Haste:140}, 2: {Strength:16, Haste:175}, 3: {Strength:20, Haste:210} } },
        { n: "Gale Lizard", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Strength:12, Luck:140}, 2: {Strength:16, Luck:175}, 3: {Strength:20, Luck:210} } },
        { n: "Lightning Lizard", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Strength:12, Mastery:140}, 2: {Strength:16, Mastery:175}, 3: {Strength:20, Mastery:210} } },
        { n: "Blackstone Marksman", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Intellect:12, Crit:140}, 2: {Intellect:16, Crit:175}, 3: {Intellect:20, Crit:210} } },
        { n: "Blackstone Guard", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Intellect:12, Haste:140}, 2: {Intellect:16, Haste:175}, 3: {Intellect:20, Haste:210} } },
        { n: "Blackstone Warrior", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Intellect:12, Luck:140}, 2: {Intellect:16, Luck:175}, 3: {Intellect:20, Luck:210} } },
        { n: "Blackstone Assaulter", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Intellect:12, Mastery:140}, 2: {Intellect:16, Mastery:175}, 3: {Intellect:20, Mastery:210} } },
        { n: "Goblin Warrior", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Agility:12, Crit:140}, 2: {Agility:16, Crit:175}, 3: {Agility:20, Crit:210} } },
        { n: "Goblin Axeman", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Agility:12, Haste:140}, 2: {Agility:16, Haste:175}, 3: {Agility:20, Haste:210} } },
        { n: "Goblin Priest", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Agility:12, Luck:140}, 2: {Agility:16, Luck:175}, 3: {Agility:20, Luck:210} } },
        { n: "Goblin Guard", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Agility:12, Mastery:140}, 2: {Agility:16, Mastery:175}, 3: {Agility:20, Mastery:210} } }
    ];

    const $ = id => document.getElementById(id);
    const createOpt = (val, txt) => `<option value="${val}">${txt || val}</option>`;
    
    // Optimizing Sigil Lookup
    const SIGIL_MAP = new Map();

    // Auto-rename sigils and Index them
    SIGIL_DB.forEach(s => {
        const k = Object.keys(s.d[1]);
        if(k.length === 1 && !s.n.includes("(")) s.n += ` (${k[0]})`;
        SIGIL_MAP.set(s.n, s);
    });

    // --- UI CONTROLLER ---
    const ui = {
        init: () => {
            $('credits-area').innerText = GAME_DATA.TEXT.CREDITS;
            $('dynamic-footer-note').innerHTML = GAME_DATA.TEXT.NOTES;
            $('class-spec').innerHTML = Object.keys(GAME_DATA.SPECS).map(s => createOpt(s)).join('');
            
            const imgOptions = Object.keys(GAME_DATA.IMAGINE.OPTIONS);
            GAME_DATA.IMAGINE.SLOT_IDS.forEach(n => {
                $(`img-type-${n}`).innerHTML = createOpt("", "- None -") + imgOptions.map(k => createOpt(k, k)).join('');
                let lvlHtml = "";
                for(let i=0; i<6; i++) lvlHtml += createOpt(i, `Tier ${i}`);
                $(`img-lvl-${n}`).innerHTML = lvlHtml;
            });

            const container = $('gear-container');
            container.innerHTML = GAME_DATA.SLOTS.map((slot, i) => {
                const isRaidSlot = GAME_DATA.RAID_SLOTS.includes(slot);
                const raidCheck = isRaidSlot ? `<input type="checkbox" id="raid-${i}" onchange="ui.toggleRaid(${i}, '${slot}')">` : '';
                const slotSigils = SIGIL_DB.filter(s => s.s.includes(slot));
                const sigilOpts = `<option value="">-</option>` + slotSigils.map(s => createOpt(s.n)).join('');

                return `
                <div class="gear-row" data-slot="${slot}">
                    <div class="slot-name">${slot}</div>
                    <div style="text-align:center">${raidCheck}</div>
                    <select id="s1-${i}" onchange="logic.updateRow(${i})"><option>-</option></select>
                    <select id="s2-${i}" onchange="logic.updateRow(${i})"><option>-</option></select>
                    <select id="s3-${i}"><option>-</option></select>
                    <select id="sigil-name-${i}" onchange="logic.calculate()">${sigilOpts}</select>
                    <select id="sigil-lvl-${i}" onchange="logic.calculate()">
                        <option value="1">Lvl 1</option><option value="2">Lvl 2</option><option value="3">Lvl 3</option>
                    </select>
                    <div class="leg-group">
                        <select id="leg-type-${i}">${GAME_DATA.LEGENDARY.map(l => createOpt(l)).join('')}</select>
                        <input type="number" id="leg-val-${i}" class="leg-val" placeholder="%">
                    </div>
                </div>`;
            }).join('');

            document.querySelectorAll('.base-stats input').forEach(el => el.addEventListener('input', logic.calculate));
            logic.updateAll();
        },

        switchTab: (tab, btn) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            $(`tab-${tab}`).classList.add('active');
            if(btn) btn.classList.add('active');
        },

        toggleRaid: (idx) => {
            const isRaid = $(`raid-${idx}`).checked;
            $(`leg-type-${idx}`).disabled = isRaid;
            $(`leg-val-${idx}`).disabled = isRaid;
            if(isRaid) { $(`leg-type-${idx}`).value = "-"; $(`leg-val-${idx}`).value = ""; }
            logic.updateRow(idx);
        }
    };

    // --- CORE LOGIC ---
    const logic = {
        getBuild: () => document.querySelector('input[name="buildType"]:checked').value,
        
        updateAll: () => { GAME_DATA.SLOTS.forEach((_, i) => logic.updateRow(i)); logic.calculate(); },

        updateRow: (idx) => {
            const slot = GAME_DATA.SLOTS[idx];
            const build = logic.getBuild();
            const isRaid = $(`raid-${idx}`)?.checked || false;
            const [s1, s2, s3] = [`s1-${idx}`, `s2-${idx}`, `s3-${idx}`].map($);

            if(isRaid) {
                const specs = GAME_DATA.SPECS[$('class-spec').value];
                // Reuse existing function to prevent thrashing if value matches
                logic.fillSelect(s1, specs[0], null, false, [], true); 
                logic.fillSelect(s2, specs[1], null, false, [], true);
                s1.disabled = true; s2.disabled = true;
                
                s3.disabled = (slot === "Weapon");
                if(slot === "Weapon") s3.value = ""; else logic.fillSelect(s3, s3.value, null, false);
            } else {
                s1.disabled = s2.disabled = s3.disabled = false;
                const banned = GAME_DATA.RESTRICTIONS[slot]?.[build] || [];
                logic.fillSelect(s1, s1.value, s2.value, true, banned);
                logic.fillSelect(s2, s2.value, s1.value, true, banned);
                logic.fillSelect(s3, s3.value, null, false);
            }
        },

        fillSelect: (el, curr, excl, restricted, banned=[], forceVal=false) => {
            const opts = GAME_DATA.STATS
                .filter(s => (!restricted || !banned.includes(s)) && s !== excl);
            
            // Optimization: Only rebuild HTML if options length changed significantly or first load
            // For simplicitly here, we just rebuild strings but check value retention
            const html = '<option value="">-</option>' + opts.map(s => `<option value="${s}">${s}</option>`).join('');
            
            if (el.innerHTML !== html) {
                el.innerHTML = html;
            }
            
            if (forceVal) {
                el.value = curr;
            } else {
                // Keep current value if valid in new list, else reset
                if (curr && opts.includes(curr)) el.value = curr;
                else if (el.value !== "" && !opts.includes(el.value)) el.value = "";
            }
        },

        applyGlobal: (type, val) => {
            if(!val) return;
            GAME_DATA.SLOTS.forEach((_, i) => { 
                if(type === 'reforge' && !$(`s3-${i}`).disabled) $(`s3-${i}`).value = val;
                if(type === 'sigil-lvl') $(`sigil-lvl-${i}`).value = val;
            });
            logic.calculate();
        },

        clearAll: () => {
             GAME_DATA.SLOTS.forEach((_, i) => {
                 // Reset Raid
                 const raidCheck = $(`raid-${i}`);
                 if(raidCheck) {
                     raidCheck.checked = false;
                     ui.toggleRaid(i); // This re-enables inputs
                 }

                 // Reset Stats
                 $(`s1-${i}`).value = "";
                 $(`s2-${i}`).value = "";
                 $(`s3-${i}`).value = "";
                 logic.updateRow(i); // Refresh options logic

                 // Reset Sigils
                 $(`sigil-name-${i}`).value = "";
                 $(`sigil-lvl-${i}`).value = "1";

                 // Reset Legendary
                 $(`leg-type-${i}`).value = "-";
                 $(`leg-val-${i}`).value = "";
             });

             // Reset Imagine
             GAME_DATA.IMAGINE.SLOT_IDS.forEach(n => {
                $(`img-type-${n}`).value = "";
                $(`img-lvl-${n}`).value = "0";
             });

             // Reset Globals
             $('global-sigil-lvl').value = "";

             // Recalculate
             logic.calculate();
        },

        // --- CURVE LOGIC ---
        getStatPercent: (stat, val) => {
            const tiers = GAME_DATA.TIERS[stat];
            if (!tiers || val <= 0) return tiers[0][1];
            if (val >= tiers[tiers.length-1][0]) return tiers[tiers.length-1][1];

            // Linear scan is fast enough for 15 items
            for (let i = 0; i < tiers.length - 1; i++) {
                if (val >= tiers[i][0] && val < tiers[i+1][0]) {
                     const [v1, p1] = tiers[i];
                     const [v2, p2] = tiers[i+1];
                     return p1 + (val - v1) / (v2 - v1) * (p2 - p1);
                }
            }
            return 0;
        },

        // Separation of concerns: Fetch UI data -> Calc -> Update UI
        getLayoutFromUI: () => {
            const layout = { gear: [], img: [] };
            GAME_DATA.SLOTS.forEach((slot, i) => {
                const isRaid = $(`raid-${i}`)?.checked;
                const sigName = $(`sigil-name-${i}`).value;
                const sigLvl = $(`sigil-lvl-${i}`).value;
                const legType = !isRaid ? $(`leg-type-${i}`).value : "-";
                const legVal = !isRaid ? (parseFloat($(`leg-val-${i}`).value)||0) : 0;
                
                layout.gear.push({
                    raid: isRaid,
                    p: $(`s1-${i}`).value,
                    s: $(`s2-${i}`).value,
                    r: $(`s3-${i}`).value,
                    sigName, sigLvl, legType, legVal
                });
            });
            
            GAME_DATA.IMAGINE.SLOT_IDS.forEach(n => {
                layout.img.push({
                    key: $(`img-type-${n}`).value,
                    idx: parseInt($(`img-lvl-${n}`).value)
                });
            });
            return layout;
        },

        calculate: () => {
            const layout = logic.getLayoutFromUI();
            const spec = $('class-spec').value;
            const baseStats = {
                v: parseFloat($('base-vers').value)||0,
                m: parseFloat($('base-mast').value)||0,
                h: parseFloat($('base-haste').value)||0,
                c: parseFloat($('base-crit').value)||0,
                l: parseFloat($('base-luck').value)||0,
                agi: parseFloat($('base-agi').value)||0
            };

            const result = logic.calculateStatsInternal(layout, spec, baseStats);
            logic.renderStats(result);
        },

        // Pure calculation function (No DOM interaction) - heavily optimized for the loop
        calculateStatsInternal: (layout, spec, baseStats) => {
            const total = { Versatility: baseStats.v, Mastery: baseStats.m, Haste: baseStats.h, Crit: baseStats.c, Luck: baseStats.l };
            let baseAgi = baseStats.agi;
            let extraStats = {};
            const leg = { "Attack Speed":0, "Cast Speed":0 };
            
            const raidBonus = GAME_DATA.RAID_BONUS[spec];

            // Gear & Sigils
            for (let i = 0; i < layout.gear.length; i++) {
                const g = layout.gear[i];
                if (!g) continue;

                const v = (i === 0) ? (g.raid ? GAME_DATA.VALUES.W_RAID : GAME_DATA.VALUES.W_STD) : (g.raid ? GAME_DATA.VALUES.A_RAID : GAME_DATA.VALUES.A_STD);

                if(g.p) total[g.p] += v.p;
                if(g.s) total[g.s] += v.s;
                if(g.r) total[g.r] += v.r;

                if (g.legType && leg[g.legType] !== undefined) {
                    leg[g.legType] += g.legVal;
                }

                if (g.sigName) {
                    const sigData = SIGIL_MAP.get(g.sigName);
                    if(sigData && sigData.d[g.sigLvl]) {
                        for (const k in sigData.d[g.sigLvl]) {
                            const val = sigData.d[g.sigLvl][k];
                            if(total[k] !== undefined) total[k] += val;
                            else if(k === "Agility") {
                                baseAgi += val;
                                extraStats["Agility"] = (extraStats["Agility"] || 0) + val;
                            }
                            else extraStats[k] = (extraStats[k] || 0) + val;
                        }
                    }
                }
            }

            // Imagines
            for (let i = 0; i < layout.img.length; i++) {
                const im = layout.img[i];
                if(im.key && !isNaN(im.idx)) {
                    const imgData = GAME_DATA.IMAGINE.OPTIONS[im.key];
                    if(imgData) total[imgData.stat] += imgData.vals[im.idx];
                }
            }

            // Agility
            total.Haste += (baseAgi * 0.45);

            // Raid Bonus
            let appliedBonus = null;
            if (layout.gear[0] && layout.gear[0].raid && raidBonus && raidBonus.t === 'p') {
                if(raidBonus.l === "Luck") total.Luck *= (1 + raidBonus.v/100);
                if(raidBonus.l.includes("Shield")) total.Versatility *= (1 + raidBonus.v/100);
                appliedBonus = raidBonus;
            }

            return { total, leg, extraStats, appliedBonus };
        },

        renderStats: (res) => {
            // Display Raw
            ['vers','mast','haste','crit','luck'].forEach((k,i) => $(`raw-${k}`).innerText = res.total[GAME_DATA.STATS[i]].toFixed(0));

            // Display Final
            $('r-vers').innerText = logic.getStatPercent("Versatility", res.total.Versatility).toFixed(2) + "%";
            $('r-mast').innerText = logic.getStatPercent("Mastery", res.total.Mastery).toFixed(2) + "%";
            $('r-haste').innerText = logic.getStatPercent("Haste", res.total.Haste).toFixed(2) + "%";
            $('r-crit').innerText = logic.getStatPercent("Crit", res.total.Crit).toFixed(2) + "%";
            $('r-luck').innerText = logic.getStatPercent("Luck", res.total.Luck).toFixed(2) + "%";

            // Extras
            let extraHTML = `<div style="color:var(--highlight); font-weight:bold; margin-bottom:8px; border-bottom:1px solid #333; padding-bottom:3px;">Extra Bonuses</div>`;
            if(res.appliedBonus) {
                let valStr = `+${res.appliedBonus.v}%`;
                extraHTML += `<div style="color:var(--text-main); font-size:0.9em; display:flex; justify-content:space-between; margin-bottom:4px;"><span>Raid ${res.appliedBonus.l}:</span> <span style="color:var(--accent); font-weight:bold;">${valStr}</span></div>`;
            }
            for (const [stat, val] of Object.entries(res.extraStats)) {
                if(val > 0) extraHTML += `<div style="color:var(--text-muted); font-size:0.9em; display:flex; justify-content:space-between; margin-bottom:4px;"><span>${stat}:</span> <span style="color:var(--accent); font-weight:bold;">+${val}</span></div>`;
            }
            $('extra-bonuses').innerHTML = extraHTML;

            // Legendary
            let legHTML = "";
            if (res.leg["Cast Speed"] > 0) legHTML += `<div class="raw-row"><span>Cast Spd:</span> <span style="color:var(--accent)">+${res.leg["Cast Speed"]}%</span></div>`;
            if (res.leg["Attack Speed"] > 0) legHTML += `<div class="raw-row"><span>Atk Spd:</span> <span style="color:var(--accent)">+${res.leg["Attack Speed"]}%</span></div>`;
            $('legendary-summary').innerHTML = legHTML;
            $('legendary-summary').style.display = legHTML ? 'block' : 'none';
        }
    };

    // --- OPTIMIZER (REWRITTEN FOR STABILITY & SPEED) ---
    const optimizer = {
        cloneLayout: (l) => {
            // Much faster than JSON.parse(JSON.stringify)
            const newGear = new Array(l.gear.length);
            for(let i=0; i<l.gear.length; i++) {
                if(l.gear[i]) newGear[i] = { ...l.gear[i] };
                else newGear[i] = null;
            }
            const newImg = l.img.map(x => ({...x}));
            return { gear: newGear, img: newImg };
        },

        run: () => {
            const targets = {
                v: parseFloat($('opt-vers').value)||0, m: parseFloat($('opt-mast').value)||0,
                h: parseFloat($('opt-haste').value)||0, c: parseFloat($('opt-crit').value)||0, l: parseFloat($('opt-luck').value)||0
            };
            const baseStats = {
                v: parseFloat($('base-vers').value)||0,
                m: parseFloat($('base-mast').value)||0,
                h: parseFloat($('base-haste').value)||0,
                c: parseFloat($('base-crit').value)||0,
                l: parseFloat($('base-luck').value)||0,
                agi: parseFloat($('opt-agi').value)||0 // Use opt input for Agi in simulator
            };
            
            const spec = $('class-spec').value;
            const keep = $('opt-keep-selected').checked;
            const optImg = $('opt-optimize-imagine').checked;
            const unlimRaid = $('opt-unlimited-raid').checked;
            const build = logic.getBuild();
            const specStats = GAME_DATA.SPECS[spec];
            const currentLayout = logic.getLayoutFromUI();

            $('opt-status').innerText = "Simulating...";
            
            // Use setTimeout to allow UI to render the "Simulating" text before freezing calculation
            setTimeout(() => {
                let best = { layout: null, diff: Infinity };
                
                // Increased iterations because logic is faster now
                const POPULATION = 30;
                const GENERATIONS = 300; 

                for(let r=0; r < POPULATION; r++) {
                    let layout = optimizer.genLayout(build, specStats, keep, optImg, unlimRaid, currentLayout);
                    let diff = optimizer.calcDiff(layout, spec, baseStats, targets);
                    
                    for(let i=0; i < GENERATIONS; i++) {
                        let mut = optimizer.cloneLayout(layout);
                        optimizer.mutate(mut, build, optImg, specStats);
                        let d = optimizer.calcDiff(mut, spec, baseStats, targets);
                        
                        if(d < diff) { layout = mut; diff = d; }
                    }
                    if(diff < best.diff) best = { layout: layout, diff: diff };
                }
                
                optimizer.apply(best.layout);
                $('opt-status').innerText = `Done! Diff: ${best.diff.toFixed(2)}`;
                ui.switchTab('planner');
                logic.calculate();
            }, 50);
        },

        calcDiff: (layout, spec, base, targets) => {
            // Internal calculation only returns RAW totals
            const res = logic.calculateStatsInternal(layout, spec, base);
            
            // Convert to percentages using curve
            const p = {
                v: logic.getStatPercent("Versatility", res.total.Versatility),
                m: logic.getStatPercent("Mastery", res.total.Mastery),
                h: logic.getStatPercent("Haste", res.total.Haste),
                c: logic.getStatPercent("Crit", res.total.Crit),
                l: logic.getStatPercent("Luck", res.total.Luck)
            };
            
            return Math.abs(p.v-targets.v) + Math.abs(p.m-targets.m) + Math.abs(p.h-targets.h) + Math.abs(p.c-targets.c) + Math.abs(p.l-targets.l);
        },

        genLayout: (build, specStats, keep, optImg, unlim, currentUI) => {
            let layout = { gear: [], img: [] };
            let locked = [], raidCnt = 0;

            if(keep) {
                currentUI.gear.forEach((g, i) => {
                    if(g.p && g.p !== "-") {
                        layout.gear.push({ ...g, locked: true });
                        locked.push(i);
                        if(g.raid) raidCnt++;
                    } else {
                        layout.gear.push(null);
                    }
                });
            } else {
                GAME_DATA.SLOTS.forEach(() => layout.gear.push(null));
            }

            let empty = GAME_DATA.SLOTS.map((_, i) => i).filter(i => !locked.includes(i));
            
            // Determine Raid Slots logic
            // 4 Raid Armors max usually, unless unlimited
            let armorIdx = [1,2,3,4,8,9]; // Armor + Accessories
            let maxRaid = unlim ? 6 : 4;
            let currentRaidCount = locked.filter(i => armorIdx.includes(i) && layout.gear[i].raid).length;
            let needed = Math.max(0, maxRaid - currentRaidCount);
            
            // Pick random slots for Raid gear
            let potentialRaidSlots = empty.filter(i => GAME_DATA.RAID_SLOTS.includes(GAME_DATA.SLOTS[i]));
            let raidPicks = potentialRaidSlots.sort(() => Math.random() - 0.5).slice(0, needed);
            
            // Always try to raid weapon if not locked
            if(!locked.includes(0)) raidPicks.push(0);

            empty.forEach(i => {
                let isRaid = raidPicks.includes(i);
                let p, s, r = "";
                
                if(isRaid) {
                    p = specStats[0]; s = specStats[1];
                    // Raid armor has reforge, weapon doesn't
                    if(GAME_DATA.SLOTS[i] !== "Weapon") {
                         r = GAME_DATA.STATS[Math.floor(Math.random()*5)];
                    }
                } else {
                    let banned = GAME_DATA.RESTRICTIONS[GAME_DATA.SLOTS[i]]?.[build] || [];
                    let av = GAME_DATA.STATS.filter(st => !banned.includes(st));
                    p = av[Math.floor(Math.random()*av.length)];
                    s = av.filter(x=>x!==p)[Math.floor(Math.random()*(av.length-1))]; // Ensure P != S
                    r = GAME_DATA.STATS[Math.floor(Math.random()*5)];
                }

                // Preserve sigil info from UI if exists, else blank for now (Optimizer focuses on Gear Stats)
                const sigName = ""; 
                const sigLvl = "1";

                layout.gear[i] = { raid: isRaid, p, s, r, sigName, sigLvl, locked: false };
            });
            
            const keys = Object.keys(GAME_DATA.IMAGINE.OPTIONS);
            if(optImg) {
                layout.img = GAME_DATA.IMAGINE.SLOT_IDS.map(() => ({ 
                    key: keys[Math.floor(Math.random()*keys.length)], 
                    idx: Math.floor(Math.random()*6) 
                }));
            } else {
                layout.img = currentUI.img.map(x => ({...x}));
            }
            return layout;
        },

        mutate: (l, build, optImg, specStats) => {
            // Pick a random gear slot
            let idx = Math.floor(Math.random() * l.gear.length);
            let g = l.gear[idx];
            
            if (!g) return;
            if (g.locked) return; // Cannot mutate locked gear
            
            // If Raid, can only mutate Reforge (if not weapon)
            if (g.raid) {
                if (GAME_DATA.SLOTS[idx] !== "Weapon") {
                    g.r = GAME_DATA.STATS[Math.floor(Math.random()*5)];
                }
                return;
            }

            // If Standard, mutate P, S or R
            let aspect = Math.floor(Math.random() * 3); 
            if(aspect === 0) { 
                let banned = GAME_DATA.RESTRICTIONS[GAME_DATA.SLOTS[idx]]?.[build] || [];
                let av = GAME_DATA.STATS.filter(st => !banned.includes(st));
                g.p = av[Math.floor(Math.random()*av.length)]; 
                // Fix S if P became same as S
                if(g.p === g.s) {
                     let avS = av.filter(x => x !== g.p);
                     if(avS.length > 0) g.s = avS[0];
                }
            } else if (aspect === 1) {
                let banned = GAME_DATA.RESTRICTIONS[GAME_DATA.SLOTS[idx]]?.[build] || [];
                let av = GAME_DATA.STATS.filter(st => !banned.includes(st));
                let possibleS = av.filter(x => x !== g.p);
                if (possibleS.length > 0) {
                    g.s = possibleS[Math.floor(Math.random() * possibleS.length)];
                }
            } else if (aspect === 2) {
                g.r = GAME_DATA.STATS[Math.floor(Math.random()*5)];
            }
            
            if(optImg && Math.random() < 0.15) {
                const keys = Object.keys(GAME_DATA.IMAGINE.OPTIONS);
                let im = l.img[Math.floor(Math.random()*l.img.length)];
                if(Math.random()<0.5) im.key = keys[Math.floor(Math.random()*keys.length)];
                else im.idx = Math.floor(Math.random()*6);
            }
        },

        apply: (l) => {
            l.gear.forEach((g, i) => {
                if(!g) return;
                const raidBox = $(`raid-${i}`);
                if(raidBox) { 
                    raidBox.checked = g.raid; 
                    ui.toggleRaid(i); // This handles disabling fields
                }
                $(`s1-${i}`).value = g.p; logic.updateRow(i); // Update row to fix S options if needed
                $(`s2-${i}`).value = g.s; 
                if(!$(`s3-${i}`).disabled) $(`s3-${i}`).value = g.r;
            });
            
            if(l.img.length) {
                l.img.forEach((im, i) => {
                    const n = GAME_DATA.IMAGINE.SLOT_IDS[i];
                    if(n) {
                        $(`img-type-${n}`).value = im.key; 
                        $(`img-lvl-${n}`).value = im.idx;
                    }
                });
            }
        }
    };

    window.addEventListener("DOMContentLoaded", ui.init);
</script>
</body>
</html>
