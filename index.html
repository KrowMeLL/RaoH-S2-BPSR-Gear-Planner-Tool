<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gear Stat Planner | Level 140</title>
    <style>
        /* =========================================
           THEME: MIDNIGHT GOLD (REFINED)
           ========================================= */
        :root {
            --bg: #0f1014; 
            --panel: #181a21; 
            --input: #0b0c10;
            --gold: #d4af37; 
            --gold-dim: #d4af3733;
            --blue: #3498db; 
            --red: #e74c3c;
            --text: #ecf0f1; 
            --muted: #7f8c8d; 
            --border: #2c3e50;
            --radius: 6px;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); color: var(--text); 
            padding: 20px; display: flex; justify-content: center; 
            min-height: 100vh; margin: 0; line-height: 1.5;
        }

        .wrapper { display: flex; flex-wrap: wrap; gap: 25px; width: 100%; max-width: 1600px; }

        /* PANELS */
        .panel { 
            background: var(--panel); padding: 25px; 
            border-radius: var(--radius); border: 1px solid var(--border); 
            box-shadow: 0 8px 24px rgba(0,0,0,0.5); 
        }
        .planner { flex: 3; min-width: 800px; }
        .calc { flex: 1; min-width: 320px; position: sticky; top: 20px; height: fit-content; background: #121319; }

        h2 { 
            text-align: center; color: var(--gold); margin: 0 0 25px; 
            border-bottom: 2px solid var(--border); padding-bottom: 15px; 
            text-transform: uppercase; letter-spacing: 2px; font-size: 1.5rem;
        }

        /* TABS */
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; }
        .tab-btn { 
            background: transparent; border: 1px solid var(--border); color: var(--muted); 
            padding: 10px 30px; cursor: pointer; border-radius: var(--radius); 
            font-weight: 700; transition: all 0.2s; text-transform: uppercase; font-size: 0.85rem;
        }
        .tab-btn:hover { border-color: var(--gold); color: var(--text); }
        .tab-btn.active { background: var(--gold); color: #000; border-color: var(--gold); }
        .content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .content.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

        /* CONTROLS AREA */
        .ctrl-box { 
            background: #1c1e26; padding: 20px; border-radius: var(--radius); 
            border: 1px solid var(--border); display: flex; flex-direction: column; 
            align-items: center; gap: 20px; margin-bottom: 25px; 
        }
        .build-sel { display: flex; gap: 15px; }
        .build-sel input { display: none; }
        .build-tag { 
            background: var(--input); border: 1px solid #444; padding: 10px 25px; 
            border-radius: var(--radius); cursor: pointer; color: var(--muted); 
            font-weight: 700; text-transform: uppercase; transition: 0.2s; font-size: 0.9rem;
        }
        .build-tag:hover { border-color: var(--gold); color: var(--text); }
        input:checked + .build-tag { background: var(--gold); color: #0f1014; border-color: var(--gold); box-shadow: 0 0 15px var(--gold-dim); }

        /* INPUTS & SELECTS */
        select, input[type="number"], input[type="text"] { 
            background: var(--input); border: 1px solid #333; color: #fff; 
            padding: 0 10px; border-radius: 4px; width: 100%; height: 38px; 
            font-size: 0.9rem; box-sizing: border-box; transition: 0.2s;
        }
        select:focus, input:focus { border-color: var(--gold); outline: none; }
        select:disabled, input:disabled { opacity: 0.3; cursor: not-allowed; border-color: transparent; }

        /* GEAR GRID */
        .gear-head, .gear-row { 
            display: grid; 
            grid-template-columns: 0.8fr 0.3fr 0.7fr 0.7fr 0.7fr 1.3fr 0.4fr 1.2fr; 
            gap: 10px; align-items: center; padding: 12px 8px; 
        }
        .gear-head { 
            color: var(--gold); font-weight: 800; border-bottom: 2px solid #444; 
            text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; margin-bottom: 5px;
        }
        .gear-row { border-bottom: 1px solid #23252e; transition: background 0.2s; }
        .gear-row:hover { background: rgba(255,255,255,0.03); }
        
        /* Clean Selects */
        .gear-row select { 
            appearance: none; -webkit-appearance: none; text-align: center; 
            cursor: pointer; background-color: #0b0c10; font-size: 0.85rem;
        }
        .gear-row select:hover { background-color: #16181f; border-color: #555; }
        
        /* Raid Checkbox */
        .gear-row input[type="checkbox"] { 
            accent-color: var(--gold); cursor: pointer; 
            transform: scale(0.9); /* Reduced Size */
            width: 16px; height: 16px;
        }

        .leg-grp { display: grid; grid-template-columns: 2fr 1fr; gap: 5px; }

        /* OPTIMIZER SPECIFIC */
        .opt-panel { background: #15171e; padding: 20px; border-radius: var(--radius); border: 1px solid #333; }
        .opt-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .opt-item label { display: block; font-size: 0.8rem; color: var(--gold); font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        
        .btn-opt { 
            width: 100%; padding: 15px; background: var(--gold); color: #0f1014; 
            border: none; border-radius: var(--radius); font-weight: 800; 
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer; 
            transition: 0.2s; font-size: 1rem; margin-top: 10px;
        }
        .btn-opt:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: 0 4px 15px var(--gold-dim); }

        .opt-toggles { 
            display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap;
        }
        .toggle-label {
            display: flex; align-items: center; gap: 8px; color: #ccc; 
            font-size: 0.9rem; font-weight: 600; cursor: pointer; 
            background: #1c1e26; padding: 8px 15px; border-radius: 20px; border: 1px solid #333;
            transition: 0.2s;
        }
        .toggle-label:hover { border-color: var(--muted); }
        .toggle-label input { width: auto; height: auto; accent-color: var(--gold); }

        /* RULES TABLE */
        .res-wrap { background: var(--input); border: 1px solid #333; border-radius: var(--radius); padding: 5px; overflow: hidden; }
        .res-tbl { width: 100%; border-collapse: collapse; }
        .res-tbl th, .res-tbl td { padding: 12px 15px; text-align: left; border: 1px solid #2c3e50; font-size: 0.9rem; }
        .res-tbl th { background: #1c1e26; color: var(--text); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        .res-tbl tr:nth-child(even) { background-color: rgba(255,255,255,0.02); }
        .res-tbl tr:hover { background-color: rgba(255,255,255,0.05); }
        .ban { color: var(--gold); font-weight: bold; }

        /* STATS PANEL */
        .stat-box { background: #0b0c10; border: 1px solid #333; padding: 20px; border-radius: var(--radius); margin-bottom: 25px; }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #1a1c24; font-size: 0.95rem; color: #bbb; }
        .stat-row:last-child { border-bottom: none; }
        .val { color: var(--gold); font-weight: 700; }
        
        .base-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .base-grid label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 4px; }

        .btn-upd { 
            width: 100%; padding: 12px; background: var(--blue); color: white; 
            border: none; border-radius: var(--radius); font-weight: 700; 
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; 
        }
        .btn-upd:hover { background: #2980b9; transform: translateY(-2px); }

        /* IMAGINES */
        .img-sec { margin-top: 30px; background: #1c1e26; padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); }
        .img-row { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px; align-items: center; margin-bottom: 10px; }
        .img-header { color: var(--gold); font-weight: 800; border-bottom: 1px solid #444; padding-bottom: 8px; margin-bottom: 15px; text-transform: uppercase; font-size: 0.9rem; }

        /* FOOTER & NOTES */
        .footer { 
            margin-top: 40px; border-top: 1px solid #333; padding-top: 20px; 
            color: #555; font-size: 0.75rem; text-transform: uppercase; text-align: center; letter-spacing: 1px;
        }
        .note-box { 
            font-size: 0.85rem; color: #999; margin-top: 25px; 
            background: #13141a; padding: 20px; border-radius: var(--radius); 
            border-left: 4px solid var(--border); 
        }
        .val-list { display: flex; flex-direction: column; gap: 6px; }
        .val-item { display: flex; justify-content: space-between; border-bottom: 1px dashed #333; padding-bottom: 4px; }
        .val-item span:first-child { color: var(--gold); font-weight: bold; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="panel planner">
        <h2>Gear Stat Planner | Level 140</h2>
        
        <div class="tabs">
            <button id="t-plan" class="tab-btn active" onclick="app.tab('plan')">Planner</button>
            <button id="t-opt" class="tab-btn" onclick="app.tab('opt')">Auto-Optimizer</button>
            <button id="t-rules" class="tab-btn" onclick="app.tab('rules')">Stat Rules</button>
        </div>

        <div class="ctrl-box">
            <div class="build-sel">
                <label><input type="radio" name="bld" value="Strength" checked onchange="calc.upd()"><span class="build-tag">Strength</span></label>
                <label><input type="radio" name="bld" value="Intelligence" onchange="calc.upd()"><span class="build-tag">Intelligence</span></label>
                <label><input type="radio" name="bld" value="Agility" onchange="calc.upd()"><span class="build-tag">Agility</span></label>
            </div>
            <div style="display:flex; gap:15px; align-items:center;">
                <label style="color:var(--muted); font-weight:bold; text-transform:uppercase; font-size:0.85rem;">Class Spec:</label>
                <select id="spec" onchange="calc.upd()" style="width:220px; text-align:center; border-color:var(--gold); color:var(--gold); font-weight:bold;"></select>
            </div>
        </div>

        <div id="tab-plan" class="content active">
            <div class="ctrl-box" style="flex-direction:row; justify-content:flex-start; padding:15px; background:var(--input); border:none;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <span style="color:var(--gold); font-weight:bold; font-size:0.9rem;">Set Reforge:</span>
                    <select onchange="calc.global('r', this.value)" style="width:130px;">
                        <option value="">- Select -</option>
                        <option value="Versatility">Versatility</option><option value="Mastery">Mastery</option>
                        <option value="Haste">Haste</option><option value="Crit">Crit</option><option value="Luck">Luck</option>
                    </select>
                </div>
                <div style="display:flex; gap:10px; align-items:center; margin-left:20px;">
                    <span style="color:var(--blue); font-weight:bold; font-size:0.9rem;">Set Sigil:</span>
                    <select onchange="calc.global('sl', this.value)" style="width:70px;">
                        <option value="">-</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
                    </select>
                </div>
            </div>

            <div class="gear-head">
                <div>Slot</div><div style="text-align:center">Raid</div>
                <div>Primary</div><div>Secondary</div><div>Reforge</div>
                <div>Sigil Name</div><div>Tier</div><div>Legendary Effect</div>
            </div>
            <div id="gear-grid"></div>
        </div>

        <div id="tab-opt" class="content">
            <div class="opt-panel">
                <div style="text-align:center; color:#888; margin-bottom:20px; font-size:0.9rem; font-style:italic;">
                    Define your target percentages. The system will simulate thousands of combinations.
                </div>
                <div class="opt-grid">
                    <div class="opt-item"><label>Target Vers %</label><input type="number" id="o-v" placeholder="0"></div>
                    <div class="opt-item"><label>Target Mast %</label><input type="number" id="o-m" placeholder="0"></div>
                    <div class="opt-item"><label>Target Haste %</label><input type="number" id="o-h" placeholder="0"></div>
                    <div class="opt-item"><label>Target Crit %</label><input type="number" id="o-c" placeholder="0"></div>
                    <div class="opt-item"><label>Target Luck %</label><input type="number" id="o-l" placeholder="0"></div>
                    <div class="opt-item"><label style="color:var(--red)">Total Agility</label><input type="number" id="o-agi" placeholder="Stat Value"></div>
                </div>
                
                <button class="btn-opt" onclick="opt.run()">Run Smart Optimization</button>
                <div id="opt-msg" style="text-align:center; margin-top:15px; color:var(--gold); font-weight:bold; min-height:24px;"></div>
                
                <div class="opt-toggles">
                    <label class="toggle-label"><input type="checkbox" id="o-keep"> Lock Current Gear</label>
                    <label class="toggle-label"><input type="checkbox" id="o-img"> Optimize Imagines</label>
                    <label class="toggle-label"><input type="checkbox" id="o-unlim"> Unlimited Raid Armor</label>
                </div>
            </div>
        </div>

        <div id="tab-rules" class="content">
            <div class="res-wrap">
                <table class="res-tbl">
                    <thead>
                        <tr>
                            <th style="width:25%">Equipment Slot</th>
                            <th style="width:25%; color:var(--gold)">Strength</th>
                            <th style="width:25%; color:#a9cce3">Intelligence</th>
                            <th style="width:25%; color:#f9e79f">Agility</th>
                        </tr>
                    </thead>
                    <tbody id="res-body"></tbody>
                </table>
            </div>
        </div>

        <div class="img-sec">
            <div class="img-header">Imagine Slots Configuration</div>
            <div class="img-row">
                <span style="font-weight:600; color:#ccc;">Imagine 1</span>
                <select id="im-t-1" onchange="calc.run()"></select>
                <select id="im-l-1" onchange="calc.run()"></select>
            </div>
            <div class="img-row">
                <span style="font-weight:600; color:#ccc;">Imagine 2</span>
                <select id="im-t-2" onchange="calc.run()"></select>
                <select id="im-l-2" onchange="calc.run()"></select>
            </div>
        </div>

        <div class="note-box">
            <div style="font-weight:bold; color:var(--text); margin-bottom:10px; text-transform:uppercase;">Base Item Values</div>
            <div id="note-txt" class="val-list"></div>
        </div>

        <div class="footer">
            <div id="cred"></div>
            <div style="margin-top:5px; font-weight:bold; color:#444;">Supported by: Boss the Block Father</div>
        </div>
    </div>

    <div class="panel calc">
        <h2 style="font-size:1.2rem; border:none; margin-bottom:15px;">Stats Overview</h2>
        
        <div class="stat-box">
            <h3 style="margin:0 0 10px 0; font-size:0.85rem; color:#666; text-transform:uppercase;">Raw Totals</h3>
            <div class="stat-row"><span>Versatility:</span><span class="val" id="rv">0</span></div>
            <div class="stat-row"><span>Mastery:</span><span class="val" id="rm">0</span></div>
            <div class="stat-row"><span>Haste:</span><span class="val" id="rh">0</span></div>
            <div class="stat-row"><span>Crit:</span><span class="val" id="rc">0</span></div>
            <div class="stat-row"><span>Luck:</span><span class="val" id="rl">0</span></div>
        </div>

        <div class="base-grid">
            <div><label>Base Vers</label><input type="number" id="b-v" value="0"></div>
            <div><label>Base Mast</label><input type="number" id="b-m" value="0"></div>
            <div><label>Base Haste</label><input type="number" id="b-h" value="0"></div>
            <div><label>Base Crit</label><input type="number" id="b-c" value="0"></div>
            <div><label>Base Luck</label><input type="number" id="b-l" value="0"></div>
            <div><label style="color:#aaa">Base Agi</label><input type="number" id="b-a" value="0"></div>
        </div>

        <button class="btn-upd" onclick="calc.run()">Update Stats</button>

        <div style="margin-top:25px; border-top:2px solid #333; padding-top:20px;">
            <h3 style="margin:0 0 15px 0; color:var(--text);">Final Breakdown</h3>
            <div class="stat-row" style="font-size:1rem;"><span>Versatility:</span><span class="val" id="fv">0%</span></div>
            <div class="stat-row" style="font-size:1rem;"><span>Mastery:</span><span class="val" id="fm">6.00%</span></div>
            <div class="stat-row" style="font-size:1rem;"><span>Haste:</span><span class="val" id="fh">0%</span></div>
            <div class="stat-row" style="font-size:1rem;"><span>Crit Rate:</span><span class="val" id="fc">5.00%</span></div>
            <div class="stat-row" style="font-size:1rem;"><span>Luck:</span><span class="val" id="fl">5.00%</span></div>
            
            <div id="xtra" style="margin-top:20px; border-top:1px dashed #444; padding-top:15px;"></div>
            
            <div id="leg-sum" style="display:none; margin-top:15px; border-top:1px solid #333; padding-top:10px;">
                <div class="stat-row"><span>Cast Speed:</span><span id="l-cs" style="color:var(--gold)">0%</span></div>
                <div class="stat-row"><span>Atk Speed:</span><span id="l-as" style="color:var(--gold)">0%</span></div>
            </div>
        </div>
    </div>
</div>

<script>
/* ==========================================================================
   DATA CONFIGURATION
   ========================================================================== */
const CFG = {
    STATS: ["Versatility", "Mastery", "Haste", "Crit", "Luck"],
    SLOTS: ["Weapon", "Helmet", "Chest", "Gloves", "Boots", "Earrings", "Necklace", "Ring", "Bracelet (L)", "Bracelet (R)", "Charm"],
    RAID_SLOTS: ["Weapon", "Helmet", "Chest", "Gloves", "Boots", "Bracelet (L)", "Bracelet (R)"],
    
    VALS: { 
        W_RAID: { p: 1966, s: 1966, r: 0 },   A_RAID: { p: 1512, s: 756, r: 453 },
        W_STD:  { p: 756,  s: 756,  r: 226 }, A_STD:  { p: 756,  s: 378, r: 226 }
    },

    RULES: { 
        "Helmet":       { "Strength": ["Versatility"], "Intelligence": ["Crit"], "Agility": ["Haste"] },
        "Chest":        { "Strength": ["Luck"], "Intelligence": ["Crit"], "Agility": ["Mastery"] },
        "Gloves":       { "Strength": ["Haste"], "Intelligence": ["Versatility"], "Agility": ["Crit"] },
        "Boots":        { "Strength": ["Mastery"], "Intelligence": ["Luck"], "Agility": ["Crit"] },
        "Earrings":     { "Strength": ["Mastery"], "Intelligence": ["Versatility"], "Agility": ["Haste"] },
        "Necklace":     { "Strength": ["Haste"], "Intelligence": ["Luck"], "Agility": ["Mastery"] },
        "Ring":         { "Strength": ["Luck"], "Intelligence": ["Mastery"], "Agility": ["Versatility"] },
        "Bracelet (L)": { "Strength": ["Crit"], "Intelligence": ["Haste"], "Agility": ["Versatility"] },
        "Bracelet (R)": { "Strength": ["Crit"], "Intelligence": ["Mastery"], "Agility": ["Luck"] },
        "Charm":        { "Strength": ["Versatility"], "Intelligence": ["Haste"], "Agility": ["Luck"] }
    },

    IMG: {
        IDS: ['1', '2'],
        OPTS: {
            "Phantom Arachnocrab (Mastery)": { s: "Mastery", v: [3584, 4636, 5688, 6740, 7792, 8960] },
            "Celestial Flier (Haste)":       { s: "Haste",   v: [3584, 4636, 5688, 6740, 7792, 8960] },
            "Goblin King (Versatility)":     { s: "Versatility", v: [3584, 4636, 5688, 6740, 7792, 8960] },
            "Bluespine Lizard (Versatility)":{ s: "Versatility", v: [2016, 2615, 3214, 3813, 4412, 5040] }
        }
    },

    BONUS: {
        "Block": { l: "Luck", v: 6.0, t: "p" }, "Earthfort": { l: "Shield (Vers)", v: 0.0, t: "p" },
        "Iado": { l: "Crit DMG", v: 0.0, t: "p" }, "Moonstrike": { l: "Luck", v: 0.0, t: "p" },
        "Icicle": { l: "Crit DMG", v: 0.0, t: "p" }, "Frostbeam": { l: "Ranged DMG", v: 0, t: "f" },
        "Vanguard": { l: "Melee DMG", v: 0, t: "f" }, "Skyward": { l: "Lucky Strike DMG", v: 20.0, t: "p" },
        "Smite": { l: "Ranged DMG", v: 0, t: "f" }, "Lifebind": { l: "Healing Output", v: 0.0, t: "p" },
        "Wildpack": { l: "Ranged DMG", v: 0, t: "f" }, "Falconry": { l: "Crit DMG", v: 0.0, t: "p" },
        "Recovery": { l: "DMG Bonus", v: 0.0, t: "p" }, "Shield": { l: "Melee DMG", v: 0, t: "f" },
        "Concerto": { l: "Crit Healing", v: 0.0, t: "p" }, "Dissonance": { l: "Luck Effect DMG", v: 0, t: "f" }
    },

    SPECS: { "Vanguard": ["Haste", "Mastery"], "Skyward": ["Crit", "Luck"], "Shield": ["Haste", "Mastery"], "Recovery": ["Crit", "Mastery"], "Iado": ["Crit", "Mastery"], "Moonstrike": ["Haste", "Luck"], "Icicle": ["Crit", "Luck"], "Frostbeam": ["Haste", "Mastery"], "Smite": ["Mastery", "Luck"], "Lifebind": ["Haste", "Mastery"], "Earthfort": ["Mastery", "Versatility"], "Block": ["Mastery", "Luck"], "Wildpack": ["Haste", "Mastery"], "Falconry": ["Crit", "Haste"], "Dissonance": ["Haste", "Luck"], "Concerto": ["Haste", "Crit"] },

    SIGILS: [
        { n: "Basilisk Sigil (Legendary)", s: ["Weapon"], d: { 1: {"All Element Attack": 70} } },
        { n: "Bluespine Lizard", s: ["Weapon"], d: { 1: {"All Element Attack": 20} } },
        { n: "Emerald Caprahorn", s: ["Weapon","Earrings","Necklace","Ring"], d: { 1: {Endurance:80, Strength:25} } },
        { n: "Blackstone Commander", s: ["Weapon","Earrings","Necklace","Ring"], d: { 1: {Endurance:80, Intellect:25} } },
        { n: "Blackfire Foxen", s: ["Weapon","Earrings","Necklace","Ring"], d: { 1: {Endurance:80, Agility:25} } },
        { n: "Flamehorn (Legendary)", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Versatility:500} } },
        { n: "Blackstone Captain (Leg)", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Mastery:500} } },
        { n: "Cabbage Kingpin (Leg)", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Luck:500} } },
        { n: "Crimson Foxen (Leg)", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Haste:500} } },
        { n: "Goblin Chief (Leg)", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Crit:500} } },
        { n: "Cabbage Blaster", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Versatility:200} } },
        { n: "Glimmer Caprahorn", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Mastery:200} } },
        { n: "Cabbage Tough Guy", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Luck:200} } },
        { n: "Wasteland Foxen", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Haste:200} } },
        { n: "Cabbage Killer", s: ["Helmet","Chest","Gloves","Boots"], d: { 1: {Crit:200} } },
        { n: "Foxen", s: ["Earrings","Necklace","Ring"], d: { 1: {Endurance:50, Agility:15} } },
        { n: "Cabbage Hunter", s: ["Earrings","Necklace","Ring"], d: { 1: {Endurance:50, Intellect:15} } },
        { n: "Nether Caprahorn", s: ["Earrings","Necklace","Ring"], d: { 1: {Endurance:50, Strength:15} } },
        { n: "Blackstone Vanguard", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Haste:300} } },
        { n: "Ruthless Cabbage", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Luck:300} } },
        { n: "Gloomy Cabbage", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Crit:300} } },
        { n: "Goblin Shaman", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Versatility:300} } },
        { n: "Goblin Trickster", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Mastery:300} } },
        { n: "Frost Lizard", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Strength:12, Crit:140} } },
        { n: "Magma Lizard", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Strength:12, Haste:140} } },
        { n: "Gale Lizard", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Strength:12, Luck:140} } },
        { n: "Lightning Lizard", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Strength:12, Mastery:140} } },
        { n: "Blackstone Marksman", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Intellect:12, Crit:140} } },
        { n: "Blackstone Guard", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Intellect:12, Haste:140} } },
        { n: "Blackstone Warrior", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Intellect:12, Luck:140} } },
        { n: "Blackstone Assaulter", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Intellect:12, Mastery:140} } },
        { n: "Goblin Warrior", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Agility:12, Crit:140} } },
        { n: "Goblin Axeman", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Agility:12, Haste:140} } },
        { n: "Goblin Priest", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Agility:12, Luck:140} } },
        { n: "Goblin Guard", s: ["Bracelet (L)","Bracelet (R)","Charm"], d: { 1: {Agility:12, Mastery:140} } }
    ],

    LEGENDARY: ["-", "Attack Speed", "Cast Speed", "ATK/MATK", "Dmg Bonus", "Shield", "Healing Output", "Res Break", "All Res", "Armor", "Max HP"],
    TEXT: { 
        CREDITS: "Produced by Luxxos // Updated by: RaoH", 
        NOTES: `
            <div class='val-item'><span>Raid Weapon</span> <span>2480 Primary / 2480 Secondary</span></div>
            <div class='val-item'><span>Raid Armor</span> <span>1512 Primary / 756 Secondary / 453 Reforge</span></div>
            <div class='val-item'><span>Standard Weapon</span> <span>1908 Primary / 954 Secondary / 572 Reforge</span></div>
            <div class='val-item'><span>Standard Armor</span> <span>954 Primary / 477 Secondary / 286 Reforge</span></div>
        ` 
    }
};

// --- CORE LOGIC ---
const $ = id => document.getElementById(id);
const cOpt = (v, t) => `<option value="${v}">${t||v}</option>`;

// Auto-rename sigils
CFG.SIGILS.forEach(s => {
    const k = Object.keys(s.d[1]);
    if(k.length === 1 && !s.n.includes("(")) s.n += ` (${k[0]})`;
});

const app = {
    init: () => {
        $('cred').innerText = CFG.TEXT.CREDITS; $('note-txt').innerHTML = CFG.TEXT.NOTES;
        $('spec').innerHTML = Object.keys(CFG.SPECS).map(s => cOpt(s)).join('');
        
        const tiers = Array.from({length:6},(_,i)=>cOpt(i,`Tier ${i+1}`)).join('');
        const imgs = cOpt("","-")+Object.keys(CFG.IMG.OPTS).map(t=>cOpt(t)).join('');
        CFG.IMG.IDS.forEach(n => { $(`im-t-${n}`).innerHTML = imgs; $(`im-l-${n}`).innerHTML = tiers; });

        $('gear-grid').innerHTML = CFG.SLOTS.map((slot, i) => {
            const isRaid = CFG.RAID_SLOTS.includes(slot);
            const sigs = cOpt("") + CFG.SIGILS.filter(s => s.s.includes(slot)).map(s => cOpt(s.n)).join('');
            return `
            <div class="gear-row" data-i="${i}">
                <div style="font-weight:600; color:#ccc; font-size:0.9rem">${slot}</div>
                <div style="text-align:center">${isRaid ? `<input type="checkbox" id="c-${i}" onchange="app.tog(${i})">` : ''}</div>
                <select id="s1-${i}" onchange="calc.row(${i})"><option>-</option></select>
                <select id="s2-${i}" onchange="calc.row(${i})"><option>-</option></select>
                <select id="s3-${i}"><option>-</option></select>
                <select id="sig-${i}" onchange="calc.run()">${sigs}</select>
                <select id="slv-${i}" onchange="calc.run()"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                <div class="leg-grp"><select id="lt-${i}">${CFG.LEGENDARY.map(l=>cOpt(l)).join('')}</select><input type="number" id="lv-${i}" placeholder="%"></div>
            </div>`;
        }).join('');

        $('res-body').innerHTML = Object.keys(CFG.RULES).map(slot => {
            const r = CFG.RULES[slot], fmt = a => a&&a.length ? `<span class="ban">${a.join(", ")}</span>` : "-";
            return `<tr><td style="color:#fff; font-weight:bold">${slot}</td><td>${fmt(r.Strength)}</td><td>${fmt(r.Intelligence)}</td><td>${fmt(r.Agility)}</td></tr>`;
        }).join('');

        document.querySelectorAll('.base-grid input').forEach(e => e.addEventListener('input', calc.run));
        calc.upd();
    },
    tab: t => {
        document.querySelectorAll('.content, .tab-btn').forEach(e => e.classList.remove('active'));
        $(`tab-${t}`).classList.add('active'); $(`t-${t}`).classList.add('active');
    },
    tog: i => {
        const on = $(`c-${i}`).checked;
        [`lt-${i}`,`lv-${i}`].forEach(id => { $(id).disabled = on; if(on) $(id).value = (id.includes('lt')?"-":""); });
        calc.row(i);
    }
};

const calc = {
    getBld: () => document.querySelector('input[name="bld"]:checked').value,
    upd: () => { CFG.SLOTS.forEach((_,i) => calc.row(i)); calc.run(); },
    row: i => {
        const slot = CFG.SLOTS[i], bld = calc.getBld(), isRaid = $(`c-${i}`)?.checked;
        const [s1, s2, s3] = [`s1-${i}`,`s2-${i}`,`s3-${i}`].map($);
        
        if (isRaid) {
            const sp = CFG.SPECS[$('spec').value];
            s1.innerHTML=cOpt(sp[0]); s1.value=sp[0]; s1.disabled=true;
            s2.innerHTML=cOpt(sp[1]); s2.value=sp[1]; s2.disabled=true;
            s3.disabled = (slot === "Weapon");
            if(slot==="Weapon") s3.value=""; else calc.fill(s3, s3.value);
        } else {
            [s1,s2,s3].forEach(e => e.disabled=false);
            const bans = CFG.RULES[slot]?.[bld] || [];
            calc.fill(s1, s1.value, s2.value, true, bans);
            calc.fill(s2, s2.value, s1.value, true, bans);
            calc.fill(s3, s3.value);
        }
    },
    fill: (el, cur, exc, res, bans=[]) => {
        el.innerHTML = cOpt("") + CFG.STATS.filter(s => (!res || !bans.includes(s)) && s !== exc).map(s=>cOpt(s)).join('');
        el.value = (cur && Array.from(el.options).some(o=>o.value===cur)) ? cur : "";
    },
    global: (t, v) => {
        if(!v) return;
        CFG.SLOTS.forEach((_,i) => {
            if(t==='r' && !$(`s3-${i}`).disabled) $(`s3-${i}`).value = v;
            if(t==='sl') $(`slv-${i}`).value = v;
        });
        calc.run();
    },
    run: () => {
        let tot = { Versatility:0, Mastery:0, Haste:0, Crit:0, Luck:0 }, leg = {"Attack Speed":0, "Cast Speed":0};
        let bAgi = parseFloat($('b-a').value)||0, xtra = {};
        const spec = $('spec').value, rb = CFG.BONUS[spec];
        // Fix: Check explicitly if WEAPON (Slot 0) is RAID
        const isWR = $('c-0') ? $('c-0').checked : false;

        // Base
        CFG.STATS.forEach(k => tot[k] += parseFloat($(`b-${k[0].toLowerCase()}`).value)||0);

        // Gear
        CFG.SLOTS.forEach((slot, i) => {
            const [p, s, r] = [`s1-${i}`,`s2-${i}`,`s3-${i}`].map(id=>$(id).value);
            const isRaid = $(`c-${i}`)?.checked;
            const V = slot==="Weapon" ? (isRaid?CFG.VALS.W_RAID:CFG.VALS.W_STD) : (isRaid?CFG.VALS.A_RAID:CFG.VALS.A_STD);
            
            if(p) tot[p]+=V.p; if(s) tot[s]+=V.s; if(r) tot[r]+=V.r;
            if(!isRaid) { const l=$(`lt-${i}`).value; if(leg[l]!==undefined) leg[l]+=parseFloat($(`lv-${i}`).value)||0; }
            
            // Sigil
            const sn=$(`sig-${i}`).value, sl=$(`slv-${i}`).value;
            if(sn) {
                const sd = CFG.SIGILS.find(x=>x.n===sn)?.d[sl];
                if(sd) Object.entries(sd).forEach(([k,v]) => {
                    if(tot[k]!==undefined) tot[k]+=v;
                    else { if(k==="Agility") bAgi+=v; xtra[k]=(xtra[k]||0)+v; }
                });
            }
        });

        // Imagines
        CFG.IMG.IDS.forEach(n => {
            const t=$(`im-t-${n}`).value, l=parseInt($(`im-l-${n}`).value);
            if(t && !isNaN(l)) { const d=CFG.IMG.OPTS[t]; tot[d.s]+=d.v[l]; }
        });

        tot.Haste += bAgi * 0.45;
        
        // FIX: Apply Raid Bonus ONLY if Weapon is Raid
        if(isWR && rb && rb.t==='p') {
            if(rb.l==="Luck") tot.Luck*=(1+rb.v/100);
            if(rb.l.includes("Shield")) tot.Versatility*=(1+rb.v/100);
        }

        // Render
        ['v','m','h','c','l'].forEach((k,i) => $(`r${k}`).innerText = tot[CFG.STATS[i]].toFixed(0));
        $('fv').innerText = ((tot.Versatility/11200)*100).toFixed(2)+"%";
        $('fm').innerText = (((tot.Mastery/20000)*100)+6).toFixed(2)+"%";
        $('fh').innerText = ((tot.Haste/20000)*100).toFixed(2)+"%";
        $('fc').innerText = (((tot.Crit/20000)*100)+5).toFixed(2)+"%";
        $('fl').innerText = (((tot.Luck/16230)*100)+5).toFixed(2)+"%";

        let xh = `<div style="color:var(--gold); font-weight:bold; margin-bottom:8px; text-transform:uppercase; font-size:0.85rem;">Active Bonuses</div>`;
        if(isWR && rb) xh += `<div class="stat-row"><span>Raid ${rb.l}:</span><span class="val">+${rb.v}${rb.t==='p'?'%':''}</span></div>`;
        Object.entries(xtra).forEach(([k,v]) => { if(v>0) xh+=`<div class="stat-row"><span>${k}:</span><span class="val">+${v}</span></div>`; });
        $('xtra').innerHTML = xh;

        $('leg-sum').style.display = (leg["Attack Speed"]>0||leg["Cast Speed"]>0)?'block':'none';
        $('l-cs').innerText = `+${leg["Cast Speed"]}%`; $('l-as').innerText = `+${leg["Attack Speed"]}%`;
    }
};

const opt = {
    run: () => {
        const tg = { v:+$('o-v').value, m:+$('o-m').value, h:+$('o-h').value, c:+$('o-c').value, l:+$('o-l').value };
        const ctx = {
            bv:+$('b-v').value, bm:+$('b-m').value, bc:+$('b-c').value, bl:+$('b-l').value,
            bh:+$('b-h').value + (+$('o-agi').value*0.45),
            spec:$('spec').value, bonus:CFG.BONUS[$('spec').value]
        };
        const keep=$('o-keep').checked, opIm=$('o-img').checked, unl=$('o-unlim').checked, bld=calc.getBld();
        
        $('opt-msg').innerText = "Simulating...";
        if(!keep) CFG.SLOTS.forEach((_,i) => { if($(`c-${i}`)) $(`c-${i}`).checked=false; });

        setTimeout(() => {
            let best = { lay: null, d: Infinity }, spStats = CFG.SPECS[ctx.spec];
            for(let r=0; r<15; r++) { 
                let lay = opt.gen(bld, spStats, keep, opIm, unl);
                let d = opt.diff(opt.eval(lay, ctx), tg);
                for(let i=0; i<1200; i++) { 
                    let mut = JSON.parse(JSON.stringify(lay));
                    opt.mut(mut, bld, opIm);
                    let nd = opt.diff(opt.eval(mut, ctx), tg);
                    if(nd < d) { lay=mut; d=nd; }
                }
                if(d < best.d) best = { lay:lay, d:d };
            }
            opt.apply(best.lay);
            $('opt-msg').innerText = "Done!"; app.tab('plan'); calc.run();
        }, 50);
    },
    eval: (l, c) => {
        let r = { Versatility:c.bv, Mastery:c.bm, Haste:c.bh, Crit:c.bc, Luck:c.bl };
        l.im.forEach(x => { const d=CFG.IMG.OPTS[x.k]; if(d) r[d.s]+=d.v[x.i]; });
        l.gr.forEach((g,i) => {
            if(!g) return;
            let v = (i===0 && g.rd) ? CFG.VALS.W_RAID : (i===0) ? CFG.VALS.W_STD : g.rd ? CFG.VALS.A_RAID : CFG.VALS.A_STD;
            if(g.p) r[g.p]+=v.p; if(g.s) r[g.s]+=v.s; if(g.r) r[g.r]+=v.r;
        });
        if(l.gr[0].rd && c.bonus && c.bonus.t==='p') {
            if(c.bonus.l==="Luck") r.Luck*=(1+c.bonus.v/100);
            if(c.bonus.l.includes("Shield")) r.Versatility*=(1+c.bonus.v/100);
        }
        return { v:r.Versatility/112, m:(r.Mastery/200)+6, h:r.Haste/200, c:(r.Crit/200)+5, l:(r.Luck/162.3)+5 };
    },
    diff: (s, t) => Math.abs(s.v-t.v)+Math.abs(s.m-t.m)+Math.abs(s.h-t.h)+Math.abs(s.c-t.c)+Math.abs(s.l-t.l),
    gen: (bld, spS, kp, opIm, unl) => {
        let l = { gr:[], im:[] }, lck=[], rc=0;
        if(kp) CFG.SLOTS.forEach((_,i) => {
            let s1=$(`s1-${i}`).value;
            if(s1) {
                let rd=$(`c-${i}`)?.checked;
                l.gr.push({ rd, p:s1, s:$(`s2-${i}`).value, r:$(`s3-${i}`).value, lk:true });
                lck.push(i); if(rd) rc++;
            } else l.gr.push(null);
        }); else CFG.SLOTS.forEach(()=>l.gr.push(null));

        let emp = CFG.SLOTS.map((_,i)=>i).filter(i=>!lck.includes(i));
        let wr = (!lck.includes(0))?true:(l.gr[0]?.rd);
        let idx = [1,2,3,4,8,9], need = Math.max(0, (unl?5:4) - lck.filter(i=>idx.includes(i) && l.gr[i].rd).length);
        let picks = emp.filter(i=>idx.includes(i)).sort(()=>Math.random()-0.5).slice(0, need);
        if(!lck.includes(0) && wr) picks.push(0);

        emp.forEach(i => {
            let rd = picks.includes(i), p, s, r=(CFG.SLOTS[i]==="Weapon"&&rd)?"":CFG.STATS[Math.floor(Math.random()*5)];
            if(rd) { p=spS[0]; s=spS[1]; } 
            else {
                let bn=CFG.RULES[CFG.SLOTS[i]]?.[bld]||[], av=CFG.STATS.filter(x=>!bn.includes(x));
                p=av[Math.floor(Math.random()*av.length)]; s=av.filter(x=>x!==p)[Math.floor(Math.random()*(av.length-1))];
            }
            l.gr[i] = { rd, p, s, r, lk:false };
        });
        
        const ik = Object.keys(CFG.IMG.OPTS);
        l.im = CFG.IMG.IDS.map((n,i) => opIm ? { k:ik[Math.floor(Math.random()*ik.length)], i:Math.floor(Math.random()*6) } : { k:$(`im-t-${n}`).value, i:+$(`im-l-${n}`).value||0 });
        return l;
    },
    mut: (l, bld, opIm) => {
        let i = Math.floor(Math.random()*l.gr.length), g=l.gr[i];
        if(g.lk && !g.rd) return; if(g.rd) return;
        let asp = Math.floor(Math.random()*3);
        let bn=CFG.RULES[CFG.SLOTS[i]]?.[bld]||[], av=CFG.STATS.filter(x=>!bn.includes(x));
        
        if(asp===0) { g.p=av[Math.floor(Math.random()*av.length)]; if(g.p===g.s) g.s=av.filter(x=>x!==g.p)[0]; }
        else if(asp===1) g.s=av.filter(x=>x!==g.p)[Math.floor(Math.random()*(av.length-1))];
        else if(!(i===0 && g.rd)) g.r=CFG.STATS[Math.floor(Math.random()*5)];
        
        if(opIm && Math.random()<0.1) {
            let im=l.im[Math.floor(Math.random()*l.im.length)], ik=Object.keys(CFG.IMG.OPTS);
            if(Math.random()<0.5) im.k=ik[Math.floor(Math.random()*ik.length)]; else im.i=Math.floor(Math.random()*6);
        }
    },
    apply: (l) => {
        l.gr.forEach((g,i) => {
            if($(`c-${i}`)) { $(`c-${i}`).checked=g.rd; app.tog(i); }
            $(`s1-${i}`).value=g.p; calc.row(i); $(`s2-${i}`).value=g.s; calc.row(i); $(`s3-${i}`).value=g.r;
        });
        l.im.forEach((m,i) => { const n=CFG.IMG.IDS[i]; if(n) { $(`im-t-${n}`).value=m.k; $(`im-l-${n}`).value=m.i; } });
    }
};

window.addEventListener("DOMContentLoaded", app.init);
</script>
</body>
</html>
